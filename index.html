<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ°”è±¡ç‰¹å·¥ï¼šæ‚‰å°¼è¡ŒåŠ¨ (Weather Agent)</title>
  
  <!-- 1. å¼•å…¥æ ·å¼åº“ (Tailwind) -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- 2. å¼•å…¥ React æ ¸å¿ƒåº“ (æ›´æ¢ä¸º cdnjs æºï¼Œæ›´ç¨³å®š) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js" crossorigin></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js" crossorigin></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js" crossorigin></script>

  <!-- è‡ªå®šä¹‰åŠ¨ç”»æ ·å¼ -->
  <style>
    @keyframes spin-slow { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    .animate-spin-slow { animation: spin-slow 8s linear infinite; }
    @keyframes fade-in-up { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    .animate-fade-in-up { animation: fade-in-up 0.5s ease-out forwards; }
    /* åŠ è½½å¤±è´¥æ—¶çš„å¤‡ç”¨æ ·å¼ */
    .loading-text { font-family: sans-serif; text-align: center; padding-top: 50px; color: #666; }
  </style>

  <!-- é”™è¯¯æ•æ‰è„šæœ¬ -->
  <script>
    window.onerror = function(msg, url, line) {
      document.getElementById('root').innerHTML = 
        '<div style="padding:20px; color:red; text-align:center;">' +
        '<h3>å¯åŠ¨å¤±è´¥ (Error)</h3>' +
        '<p>å¯èƒ½æ˜¯ç½‘ç»œåŸå› æ— æ³•åŠ è½½èµ„æºåº“ã€‚</p>' +
        '<p>è¯·ç¡®ä¿ç”µè„‘å·²è¿æ¥äº’è”ç½‘ã€‚</p>' +
        '<small>' + msg + '</small>' +
        '</div>';
      return false;
    };
  </script>
</head>
<body class="bg-slate-100 text-gray-800 font-sans">
  
  <!-- æŒ‚è½½ç‚¹ï¼šæ·»åŠ é»˜è®¤æ–‡å­—ï¼Œå¦‚æœJSåŠ è½½å¤±è´¥ï¼Œç”¨æˆ·èƒ½çœ‹åˆ°æç¤º -->
  <div id="root" class="loading-text">
    <h2 style="font-size:24px; color:#3b82f6;">æ­£åœ¨å¯åŠ¨æ°”è±¡ç‰¹å·¥ä»»åŠ¡...</h2>
    <p>Loading Mission Resources...</p>
    <br/>
    <p style="font-size:12px; color:#999;">å¦‚æœé•¿æ—¶é—´åœç•™åœ¨æ­¤é¡µé¢ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæ˜¯å¦è¿æ¥ã€‚</p>
  </div>

  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    // --- å›¾æ ‡ç»„ä»¶ (SVG) ---
    const Icon = ({ path, className, color = "currentColor" }) => (
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
        {path}
      </svg>
    );

    const Icons = {
      Sun: (props) => <Icon {...props} path={<><circle cx="12" cy="12" r="4"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="m17.66 17.66 1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="m6.34 17.66-1.41 1.41"/><path d="m19.07 4.93-1.41 1.41"/></>} />,
      Cloud: (props) => <Icon {...props} path={<path d="M17.5 19c0-3.037-2.463-5.5-5.5-5.5S6.5 15.963 6.5 19 8.963 21.5 12 21.5s5.5-2.463 5.5-5.5Z"/>} />,
      CloudRain: (props) => <Icon {...props} path={<><path d="M4 14.899A7 7 0 1 1 15.71 8h1.79a4.5 4.5 0 0 1 2.5 8.242"/><path d="M16 14v6"/><path d="M8 14v6"/><path d="M12 16v6"/></>} />,
      Wind: (props) => <Icon {...props} path={<><path d="M17.7 7.7a2.5 2.5 0 1 1 1.8 4.3H2"/><path d="M9.6 4.6A2 2 0 1 1 11 8H2"/><path d="M12.6 19.4A2 2 0 1 1 14 16H2"/></>} />,
      Snowflake: (props) => <Icon {...props} path={<><line x1="2" x2="22" y1="12" y2="12"/><line x1="12" x2="12" y1="2" y2="22"/><path d="m20 20-4-4"/><path d="m4 4 4 4"/><path d="m4 20 4-4"/><path d="m20 4-4 4"/></>} />,
      Play: (props) => <Icon {...props} path={<polygon points="5 3 19 12 5 21 5 3"/>} />,
      Volume2: (props) => <Icon {...props} path={<><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><path d="M15.54 8.46a5 5 0 0 1 0 7.07"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14"/></>} />,
      Award: (props) => <Icon {...props} path={<><circle cx="12" cy="8" r="7"/><polyline points="8.21 13.89 7 23 12 20 17 23 15.79 13.88"/></>} />,
      Star: (props) => <Icon {...props} path={<polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2" fill={props.fill || "none"}/>} />,
      CheckCircle: (props) => <Icon {...props} path={<><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></>} />,
      XCircle: (props) => <Icon {...props} path={<><circle cx="12" cy="12" r="10"/><line x1="15" x2="9" y1="9" y2="15"/><line x1="9" x2="15" y1="9" y2="15"/></>} />,
      Sparkles: (props) => <Icon {...props} path={<><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/><path d="M5 3v4"/><path d="M9 3v4"/><path d="M3 5h4"/><path d="M3 9h4"/></>} />,
      Loader: (props) => <Icon {...props} path={<path d="M21 12a9 9 0 1 1-6.219-8.56" />} />,
      Phone: (props) => <Icon {...props} path={<path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/>} />,
      Mic: (props) => <Icon {...props} path={<><path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" x2="12" y1="19" y2="22"/></>} />
    };

    // --- API Helpers ---

    const pcmToWav = (pcmData, sampleRate = 24000) => {
      const numChannels = 1;
      const bitsPerSample = 16;
      const byteRate = (sampleRate * numChannels * bitsPerSample) / 8;
      const blockAlign = (numChannels * bitsPerSample) / 8;
      const dataSize = pcmData.byteLength;
      const buffer = new ArrayBuffer(44 + dataSize);
      const view = new DataView(buffer);

      const writeString = (view, offset, string) => {
        for (let i = 0; i < string.length; i++) {
          view.setUint8(offset + i, string.charCodeAt(i));
        }
      };

      writeString(view, 0, 'RIFF');
      view.setUint32(4, 36 + dataSize, true);
      writeString(view, 8, 'WAVE');
      writeString(view, 12, 'fmt ');
      view.setUint32(16, 16, true);
      view.setUint16(20, 1, true); 
      view.setUint16(22, numChannels, true);
      view.setUint32(24, sampleRate, true);
      view.setUint32(28, byteRate, true);
      view.setUint16(32, blockAlign, true);
      view.setUint16(34, bitsPerSample, true);
      writeString(view, 36, 'data');
      view.setUint32(40, dataSize, true);
      
      const pcmBytes = new Uint8Array(pcmData);
      const wavBytes = new Uint8Array(buffer, 44);
      wavBytes.set(pcmBytes);

      return buffer;
    };

    const generateAIContent = async (prompt, key) => {
      if (!key) return "Please enter an API Key in the main menu to use this feature.";
      try {
        const response = await fetch(
          `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${key}`,
          {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
          }
        );
        const data = await response.json();
        return data.candidates?.[0]?.content?.parts?.[0]?.text || "Agent, HQ is offline. Good job anyway!";
      } catch (error) {
        console.error("AI Error:", error);
        return "Connection to HQ failed.";
      }
    };

    const generateSpeech = async (text, key) => {
      if (!key) { alert("Please enter API Key first!"); return; }
      try {
        const response = await fetch(
          `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${key}`,
          {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              contents: [{ parts: [{ text: text }] }],
              generationConfig: {
                responseModalities: ["AUDIO"],
                speechConfig: { voiceConfig: { prebuiltVoiceConfig: { voiceName: "Kore" } } }
              }
            })
          }
        );
        const data = await response.json();
        const base64Audio = data.candidates?.[0]?.content?.parts?.[0]?.inlineData?.data;
        
        if (base64Audio) {
          const binaryString = window.atob(base64Audio);
          const len = binaryString.length;
          const bytes = new Uint8Array(len);
          for (let i = 0; i < len; i++) {
            bytes[i] = binaryString.charCodeAt(i);
          }
          const wavBuffer = pcmToWav(bytes.buffer);
          const blob = new Blob([wavBuffer], { type: 'audio/wav' });
          const url = URL.createObjectURL(blob);
          const audio = new Audio(url);
          audio.play();
        }
      } catch (error) {
        console.error("TTS Error:", error);
      }
    };

    // --- Game Data ---
    const PHONETICS_DATA = [
      { word: "three", type: "unvoiced", hint: "æ°”æµéŸ³ (Î¸)" },
      { word: "they", type: "voiced", hint: "éœ‡åŠ¨éŸ³ (Ã°)" },
      { word: "father", type: "voiced", hint: "éœ‡åŠ¨éŸ³ (Ã°)" },
      { word: "think", type: "unvoiced", hint: "æ°”æµéŸ³ (Î¸)" },
      { word: "these", type: "voiced", hint: "éœ‡åŠ¨éŸ³ (Ã°)" },
      { word: "both", type: "unvoiced", hint: "æ°”æµéŸ³ (Î¸)" },
      { word: "there", type: "voiced", hint: "éœ‡åŠ¨éŸ³ (Ã°)" },
      { word: "thing", type: "unvoiced", hint: "æ°”æµéŸ³ (Î¸)" },
    ];

    const VOCAB_DATA = [
      { question: "What's the weather?", icon: <Icons.Sun className="w-16 h-16 text-yellow-500 animate-spin-slow" />, answer: "sunny", options: ["sunny", "rainy", "windy", "snowy"] },
      { question: "What's the weather?", icon: <Icons.CloudRain className="w-16 h-16 text-blue-500 animate-bounce" />, answer: "rainy", options: ["cloudy", "rainy", "hot", "cool"] },
      { question: "What's the weather?", icon: <Icons.Snowflake className="w-16 h-16 text-cyan-300 animate-pulse" />, answer: "snowy", options: ["snowy", "sunny", "warm", "bad"] },
      { question: "It's very...", icon: <div className="text-4xl">ğŸ”¥</div>, answer: "hot", options: ["cold", "hot", "cool", "warm"] },
      { question: "It's very...", icon: <Icons.Wind className="w-16 h-16 text-gray-400 animate-pulse" />, answer: "windy", options: ["windy", "sunny", "cloudy", "rainy"] },
    ];

    const LOGIC_DATA = [
      { condition: "It's cold and rainy outside.", question: "Can we play football?", answer: "No, we can't.", options: ["Yes, we can.", "No, we can't."] },
      { condition: "It's cold and rainy.", question: "What can we do at home?", answer: "Make a card.", options: ["Play football.", "Make a card."] },
      { condition: "It's sunny and warm.", question: "Can we go to the park?", answer: "Yes, we can.", options: ["Yes, we can.", "No, we can't."] },
      { condition: "It's snowy.", question: "Let's...", answer: "make a snowman", options: ["swim", "make a snowman"] },
    ];

    const DIALOGUE_DATA = [
      { speaker: "Mark", text: "Hello! Mark _______.", answer: "speaking", options: ["speaking", "talking", "saying"] },
      { speaker: "John", text: "Hi, Mark! _______ is John.", answer: "This", options: ["I", "This", "It"] },
      { speaker: "John", text: "What's the weather _______ in Sydney?", answer: "like", options: ["is", "like", "love"] },
    ];

    // --- Components ---
    const Button = ({ onClick, children, className = "", disabled = false, variant = "primary" }) => {
      const baseStyles = "px-6 py-3 rounded-full font-bold shadow-lg transform transition active:scale-95 flex items-center justify-center gap-2";
      const variants = {
        primary: "bg-gradient-to-r from-blue-500 to-indigo-600 text-white hover:-translate-y-1 hover:shadow-xl",
        secondary: "bg-white text-gray-800 border-2 border-gray-200 hover:border-blue-400 hover:bg-blue-50",
        success: "bg-green-500 text-white hover:bg-green-600",
        danger: "bg-red-500 text-white hover:bg-red-600",
        ai: "bg-gradient-to-r from-purple-500 to-pink-500 text-white hover:scale-105"
      };
      
      return (
        <button onClick={onClick} disabled={disabled} className={`${baseStyles} ${variants[variant] || variants.primary} ${className} ${disabled ? 'opacity-50 cursor-not-allowed hover:transform-none' : ''}`}>
          {children}
        </button>
      );
    };

    const Card = ({ children, className = "" }) => (
      <div className={`bg-white rounded-2xl shadow-xl p-6 md:p-8 ${className}`}>{children}</div>
    );

    const ProgressBar = ({ current, total }) => (
      <div className="w-full bg-gray-200 rounded-full h-4 mb-6">
        <div className="bg-blue-500 h-4 rounded-full transition-all duration-500" style={{ width: `${(current / total) * 100}%` }}></div>
      </div>
    );

    // --- Levels ---

    const LevelPhonetics = ({ onComplete, userKey }) => {
      const [index, setIndex] = useState(0);
      const [score, setScore] = useState(0);
      const [feedback, setFeedback] = useState(null);
      const [isPlaying, setIsPlaying] = useState(false);

      const handleChoice = (type) => {
        if (feedback) return;
        const isCorrect = PHONETICS_DATA[index].type === type;
        setFeedback(isCorrect ? 'correct' : 'wrong');
        if (isCorrect) setScore(s => s + 1);
        setTimeout(() => {
          setFeedback(null);
          if (index < PHONETICS_DATA.length - 1) setIndex(index + 1);
          else onComplete(score + (isCorrect ? 1 : 0), PHONETICS_DATA.length);
        }, 1000);
      };

      const handleSpeak = async () => {
        if (isPlaying) return;
        setIsPlaying(true);
        await generateSpeech(PHONETICS_DATA[index].word, userKey);
        setIsPlaying(false);
      };

      const item = PHONETICS_DATA[index];

      return (
        <div className="text-center max-w-md mx-auto">
          <h2 className="text-2xl font-bold text-purple-600 mb-4">Level 1: æ£®æ—ä½è¯­ (Phonetics)</h2>
          <ProgressBar current={index} total={PHONETICS_DATA.length} />
          
          <Card className="mb-8 transform transition-all hover:scale-105 border-4 border-indigo-100 flex flex-col items-center">
            <div className="text-5xl font-extrabold text-indigo-600 mb-4">{item.word}</div>
            <button 
              onClick={handleSpeak}
              disabled={isPlaying}
              className={`flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-bold transition-all shadow-sm ${isPlaying ? 'bg-gray-100 text-gray-400' : 'bg-indigo-50 text-indigo-600 hover:bg-indigo-100 hover:scale-105'}`}
            >
              {isPlaying ? <span className="flex items-center gap-2"><Icons.Loader className="animate-spin w-4 h-4"/> AI Speaking...</span> : <><Icons.Sparkles className="w-4 h-4" /> Hear AI Pronunciation</>}
            </button>
          </Card>

          <div className="grid grid-cols-2 gap-4">
            <Button onClick={() => handleChoice('voiced')} variant={feedback === 'wrong' && item.type === 'voiced' ? 'success' : 'secondary'} className="bg-yellow-50 text-yellow-900 border-yellow-200">
              <div className="flex flex-col items-center">
                 <Icons.Volume2 className="mb-1 w-6 h-6" /> <span>éœ‡åŠ¨éŸ³ /Ã°/</span>
              </div>
            </Button>
            <Button onClick={() => handleChoice('unvoiced')} variant={feedback === 'wrong' && item.type === 'unvoiced' ? 'success' : 'secondary'} className="bg-blue-50 text-blue-900 border-blue-200">
              <div className="flex flex-col items-center">
                 <Icons.Wind className="mb-1 w-6 h-6" /> <span>æ°”æµéŸ³ /Î¸/</span>
              </div>
            </Button>
          </div>
          {feedback && <div className={`mt-6 text-xl font-bold animate-bounce ${feedback === 'correct' ? 'text-green-500' : 'text-red-500'}`}>{feedback === 'correct' ? 'Great Job! ğŸ‰' : 'Oops!'}</div>}
        </div>
      );
    };

    const LevelVocab = ({ onComplete }) => {
      const [index, setIndex] = useState(0);
      const [score, setScore] = useState(0);
      const [feedback, setFeedback] = useState(null);

      const handleChoice = (option) => {
        if (feedback) return;
        const isCorrect = VOCAB_DATA[index].answer === option;
        setFeedback(isCorrect ? 'correct' : 'wrong');
        if (isCorrect) setScore(s => s + 1);
        setTimeout(() => {
          setFeedback(null);
          if (index < VOCAB_DATA.length - 1) setIndex(index + 1);
          else onComplete(score + (isCorrect ? 1 : 0), VOCAB_DATA.length);
        }, 1000);
      };

      const item = VOCAB_DATA[index];

      return (
        <div className="text-center max-w-md mx-auto">
          <h2 className="text-2xl font-bold text-orange-500 mb-4">Level 2: æ°”è±¡é›·è¾¾ (Vocabulary)</h2>
          <ProgressBar current={index} total={VOCAB_DATA.length} />
          <Card className="mb-6 flex flex-col items-center justify-center h-48 bg-gradient-to-b from-blue-50 to-blue-100">
            <div className="mb-4">{item.icon}</div>
            <p className="text-xl text-gray-700 font-semibold">{item.question}</p>
          </Card>
          <div className="grid grid-cols-2 gap-3">
            {item.options.map(opt => (
              <Button key={opt} onClick={() => handleChoice(opt)} variant={feedback === 'correct' && opt === item.answer ? 'success' : feedback === 'wrong' && opt === item.answer ? 'success' : 'secondary'} className="capitalize">{opt}</Button>
            ))}
          </div>
        </div>
      );
    };

    const LevelLogic = ({ onComplete }) => {
      const [index, setIndex] = useState(0);
      const [score, setScore] = useState(0);
      const [selected, setSelected] = useState(null);

      const handleChoice = (option) => {
        if (selected) return;
        setSelected(option);
        const isCorrect = option === LOGIC_DATA[index].answer;
        if (isCorrect) setScore(s => s + 1);
        setTimeout(() => {
          setSelected(null);
          if (index < LOGIC_DATA.length - 1) setIndex(index + 1);
          else onComplete(score + (isCorrect ? 1 : 0), LOGIC_DATA.length);
        }, 1200);
      };

      const item = LOGIC_DATA[index];

      return (
        <div className="text-center max-w-md mx-auto">
          <h2 className="text-2xl font-bold text-green-600 mb-4">Level 3: ç”Ÿå­˜æŠ‰æ‹© (Logic)</h2>
          <ProgressBar current={index} total={LOGIC_DATA.length} />
          <Card className="mb-6 bg-yellow-50 border-l-8 border-yellow-400 text-left">
            <h3 className="text-gray-500 text-sm uppercase tracking-wider mb-1">Situation</h3>
            <p className="text-xl font-bold text-gray-800">{item.condition}</p>
          </Card>
          <p className="text-lg mb-4 font-semibold text-gray-700">Question: {item.question}</p>
          <div className="space-y-3">
            {item.options.map(opt => (
              <Button key={opt} onClick={() => handleChoice(opt)} variant={selected === opt ? (opt === item.answer ? 'success' : 'danger') : (selected && opt === item.answer ? 'success' : 'secondary')} className="w-full justify-center">{opt}</Button>
            ))}
          </div>
        </div>
      );
    };

    const LevelDialogue = ({ onComplete }) => {
      const [index, setIndex] = useState(0);
      const [score, setScore] = useState(0);
      
      const handleChoice = (option) => {
        const isCorrect = option === DIALOGUE_DATA[index].answer;
        if (isCorrect) setScore(s => s + 1);
        if (index < DIALOGUE_DATA.length - 1) setIndex(index + 1);
        else onComplete(score + (isCorrect ? 1 : 0), DIALOGUE_DATA.length);
      };

      const item = DIALOGUE_DATA[index];
      const parts = item.text.split('_______');

      return (
        <div className="text-center max-w-md mx-auto">
          <h2 className="text-2xl font-bold text-pink-600 mb-4">Level 4: ç‰¹å·¥è¿çº¿ (Dialogue)</h2>
          <ProgressBar current={index} total={DIALOGUE_DATA.length} />
          <Card className="mb-8 bg-gray-50 p-6 relative">
            <div className="flex items-start gap-4 mt-2">
              <div className="w-12 h-12 rounded-full bg-blue-100 flex items-center justify-center text-2xl border-2 border-blue-200">{item.speaker === 'Mark' ? 'ğŸ§‘' : 'ğŸ‘¦'}</div>
              <div className="text-left">
                <div className="text-sm text-gray-500 font-bold mb-1">{item.speaker}</div>
                <div className="text-xl text-gray-800 leading-relaxed">{parts[0]}<span className="inline-block w-24 border-b-4 border-dashed border-blue-400 mx-1">?</span>{parts[1]}</div>
              </div>
            </div>
          </Card>
          <div className="grid grid-cols-3 gap-2">
            {item.options.map(opt => (
              <Button key={opt} onClick={() => handleChoice(opt)} variant="secondary" className="bg-indigo-50 text-indigo-700 hover:bg-indigo-100 text-sm">{opt}</Button>
            ))}
          </div>
        </div>
      );
    };

    // --- Main App ---

    function WeatherGame() {
      const [gameState, setGameState] = useState('menu');
      const [currentLevel, setCurrentLevel] = useState(1);
      const [totalScore, setTotalScore] = useState(0);
      const [maxScore, setMaxScore] = useState(0);
      const [aiReport, setAiReport] = useState(null);
      const [isGenerating, setIsGenerating] = useState(false);
      const [userKey, setUserKey] = useState('');

      const startGame = () => {
        setGameState('playing');
        setCurrentLevel(1);
        setTotalScore(0);
        setMaxScore(0);
        setAiReport(null);
      };

      const handleLevelComplete = (score, max) => {
        setTotalScore(s => s + score);
        setMaxScore(m => m + max);
        if (currentLevel < 4) setCurrentLevel(c => c + 1);
        else setGameState('victory');
      };

      const handleGenerateReport = async () => {
        setIsGenerating(true);
        const prompt = `Write a short, funny, motivating 'Secret Agent Mission Report' (2-3 sentences max) for a Grade 4 student. They completed a mission learning English weather words. Score: ${totalScore}/${maxScore}. Use simple English.`;
        const report = await generateAIContent(prompt, userKey);
        setAiReport(report);
        setIsGenerating(false);
      };

      return (
        <div className="min-h-screen flex flex-col items-center py-8 px-4">
          <header className="mb-8 text-center">
            <h1 className="text-3xl md:text-4xl font-black text-blue-600 tracking-tight flex items-center justify-center gap-2">
              <Icons.CloudRain className="w-8 h-8 text-blue-400" /> æ°”è±¡ç‰¹å·¥: æ‚‰å°¼è¡ŒåŠ¨ <Icons.Sun className="w-8 h-8 text-yellow-400" />
            </h1>
            <p className="text-gray-500 mt-2 font-medium">Unit 5: The Weather and Us</p>
          </header>

          <div className="w-full max-w-2xl bg-white rounded-3xl shadow-2xl overflow-hidden min-h-[500px] flex flex-col relative">
             <div className="absolute top-0 right-0 p-10 opacity-5 pointer-events-none"><Icons.Wind className="w-48 h-48"/></div>
             <div className="absolute bottom-0 left-0 p-10 opacity-5 pointer-events-none"><Icons.Snowflake className="w-48 h-48"/></div>

             <div className="p-6 md:p-10 flex-grow flex flex-col justify-center relative z-10">
               {gameState === 'menu' && (
                 <div className="text-center space-y-8">
                   <div className="inline-block p-6 bg-blue-50 rounded-full animate-pulse"><Icons.Play className="w-16 h-16 text-blue-600 ml-2" /></div>
                   <div><h2 className="text-2xl font-bold mb-2">å‡†å¤‡å¥½æ‰§è¡Œä»»åŠ¡äº†å—ï¼Ÿ</h2><p className="text-gray-600">ä½ çš„ç›®æ ‡ï¼šæŒæ¡æ‰€æœ‰å¤©æ°”æƒ…æŠ¥ï¼</p></div>
                   
                   <div className="max-w-xs mx-auto text-left bg-gray-50 p-4 rounded-lg border border-gray-200">
                      <label className="block text-xs font-bold text-gray-500 uppercase mb-1">Gemini API Key (å¯é€‰)</label>
                      <input 
                        type="password" 
                        placeholder="åœ¨æ­¤ç²˜è´´ Key ä»¥å¯ç”¨ AI" 
                        className="w-full p-2 border rounded text-sm mb-2"
                        value={userKey}
                        onChange={(e) => setUserKey(e.target.value)}
                      />
                      <p className="text-xs text-gray-400">ä¸å¡«ä¹Ÿå¯ä»¥ç©åŸºç¡€ç‰ˆå“¦ã€‚</p>
                   </div>

                   <Button onClick={startGame} className="w-full text-xl py-4">å¼€å§‹è¡ŒåŠ¨ (Start Mission)</Button>
                 </div>
               )}

               {gameState === 'playing' && (
                 <>
                   {currentLevel === 1 && <LevelPhonetics onComplete={handleLevelComplete} userKey={userKey} />}
                   {currentLevel === 2 && <LevelVocab onComplete={handleLevelComplete} />}
                   {currentLevel === 3 && <LevelLogic onComplete={handleLevelComplete} />}
                   {currentLevel === 4 && <LevelDialogue onComplete={handleLevelComplete} />}
                 </>
               )}

               {gameState === 'victory' && (
                 <div className="text-center animate-fade-in-up">
                   <div className="flex justify-center mb-6"><Icons.Award className="w-20 h-20 text-yellow-400 drop-shadow-lg" /></div>
                   <h2 className="text-4xl font-extrabold text-gray-800 mb-2">ä»»åŠ¡å®Œæˆ!</h2>
                   
                   <div className="bg-gray-50 rounded-xl p-6 mb-8 max-w-xs mx-auto">
                     <div className="text-gray-500 uppercase text-xs font-bold tracking-wider mb-2">Final Score</div>
                     <div className="text-5xl font-black text-blue-600 mb-2">{totalScore} <span className="text-2xl text-gray-400">/ {maxScore}</span></div>
                   </div>

                   {!aiReport ? (
                     <div className="mb-8">
                       <Button variant="ai" onClick={handleGenerateReport} disabled={isGenerating} className="w-full justify-center">
                         {isGenerating ? <Icons.Loader className="animate-spin w-4 h-4" /> : <Icons.Sparkles className="w-4 h-4" />}
                         {isGenerating ? "Connecting..." : "Generate Report"}
                       </Button>
                     </div>
                   ) : (
                     <Card className="mb-8 bg-gradient-to-br from-purple-50 to-pink-50 border-2 border-purple-100 transform rotate-1">
                        <h3 className="font-bold text-purple-600 text-sm uppercase tracking-widest mb-2">TOP SECRET: HQ REPORT</h3>
                        <p className="text-gray-700 italic font-medium leading-relaxed">"{aiReport}"</p>
                     </Card>
                   )}

                   <Button onClick={startGame} variant="success" className="w-full">å†ç©ä¸€æ¬¡ (Play Again)</Button>
                 </div>
               )}
             </div>
          </div>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<WeatherGame />);
  </script>
</body>
</html>
