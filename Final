import React, { useState, useEffect, useRef } from 'react';
import { Play, Volume2, Sun, Cloud, CloudRain, Wind, Snowflake, Phone, Award, ArrowRight, CheckCircle, XCircle, Star, Sparkles, Mic, Loader } from 'lucide-react';

// --- Configuration ---
const apiKey = ""; // System provides the key

// --- API Helpers ---

// 1. Gemini Text Generation (Chat)
const generateAIContent = async (prompt) => {
  try {
    const response = await fetch(
      `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`,
      {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          contents: [{ parts: [{ text: prompt }] }]
        })
      }
    );
    const data = await response.json();
    return data.candidates?.[0]?.content?.parts?.[0]?.text || "Agent, HQ is offline. Good job anyway!";
  } catch (error) {
    console.error("AI Error:", error);
    return "Connection to HQ failed. But you are still a hero!";
  }
};

// 2. Gemini Text-to-Speech (TTS)
// Helper: PCM to WAV Converter
const pcmToWav = (pcmData, sampleRate = 24000) => {
  const numChannels = 1;
  const bitsPerSample = 16;
  const byteRate = (sampleRate * numChannels * bitsPerSample) / 8;
  const blockAlign = (numChannels * bitsPerSample) / 8;
  const dataSize = pcmData.byteLength;
  const buffer = new ArrayBuffer(44 + dataSize);
  const view = new DataView(buffer);

  const writeString = (view, offset, string) => {
    for (let i = 0; i < string.length; i++) {
      view.setUint8(offset + i, string.charCodeAt(i));
    }
  };

  writeString(view, 0, 'RIFF');
  view.setUint32(4, 36 + dataSize, true);
  writeString(view, 8, 'WAVE');
  writeString(view, 12, 'fmt ');
  view.setUint32(16, 16, true);
  view.setUint16(20, 1, true); // PCM format
  view.setUint16(22, numChannels, true);
  view.setUint32(24, sampleRate, true);
  view.setUint32(28, byteRate, true);
  view.setUint16(32, blockAlign, true);
  view.setUint16(34, bitsPerSample, true);
  writeString(view, 36, 'data');
  view.setUint32(40, dataSize, true);
  
  // Write PCM data
  const pcmBytes = new Uint8Array(pcmData);
  const wavBytes = new Uint8Array(buffer, 44);
  wavBytes.set(pcmBytes);

  return buffer;
};

const generateSpeech = async (text) => {
  try {
    const response = await fetch(
      `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`,
      {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          contents: [{ parts: [{ text: text }] }],
          generationConfig: {
            responseModalities: ["AUDIO"],
            speechConfig: {
              voiceConfig: {
                prebuiltVoiceConfig: {
                  voiceName: "Kore" // 'Kore' is a nice clear voice
                }
              }
            }
          }
        })
      }
    );
    const data = await response.json();
    const base64Audio = data.candidates?.[0]?.content?.parts?.[0]?.inlineData?.data;
    
    if (base64Audio) {
      // Decode Base64 to binary
      const binaryString = window.atob(base64Audio);
      const len = binaryString.length;
      const bytes = new Uint8Array(len);
      for (let i = 0; i < len; i++) {
        bytes[i] = binaryString.charCodeAt(i);
      }
      // Convert PCM to WAV
      const wavBuffer = pcmToWav(bytes.buffer);
      // Create Blob and play
      const blob = new Blob([wavBuffer], { type: 'audio/wav' });
      const url = URL.createObjectURL(blob);
      const audio = new Audio(url);
      audio.play();
    }
  } catch (error) {
    console.error("TTS Error:", error);
  }
};


// --- Data & Assets ---

const PHONETICS_DATA = [
  { word: "three", type: "unvoiced", hint: "æ°”æµéŸ³ (Î¸)" },
  { word: "they", type: "voiced", hint: "éœ‡åŠ¨éŸ³ (Ã°)" },
  { word: "father", type: "voiced", hint: "éœ‡åŠ¨éŸ³ (Ã°)" },
  { word: "think", type: "unvoiced", hint: "æ°”æµéŸ³ (Î¸)" },
  { word: "these", type: "voiced", hint: "éœ‡åŠ¨éŸ³ (Ã°)" },
  { word: "both", type: "unvoiced", hint: "æ°”æµéŸ³ (Î¸)" },
  { word: "there", type: "voiced", hint: "éœ‡åŠ¨éŸ³ (Ã°)" },
  { word: "thing", type: "unvoiced", hint: "æ°”æµéŸ³ (Î¸)" },
];

const VOCAB_DATA = [
  { question: "What's the weather?", icon: <Sun className="w-16 h-16 text-yellow-500 animate-spin-slow" />, answer: "sunny", options: ["sunny", "rainy", "windy", "snowy"] },
  { question: "What's the weather?", icon: <CloudRain className="w-16 h-16 text-blue-500 animate-bounce" />, answer: "rainy", options: ["cloudy", "rainy", "hot", "cool"] },
  { question: "What's the weather?", icon: <Snowflake className="w-16 h-16 text-cyan-300 animate-pulse" />, answer: "snowy", options: ["snowy", "sunny", "warm", "bad"] },
  { question: "It's very...", icon: <div className="text-4xl">ğŸ”¥</div>, answer: "hot", options: ["cold", "hot", "cool", "warm"] },
  { question: "It's very...", icon: <Wind className="w-16 h-16 text-gray-400 animate-pulse" />, answer: "windy", options: ["windy", "sunny", "cloudy", "rainy"] },
];

const LOGIC_DATA = [
  { condition: "It's cold and rainy outside.", question: "Can we play football?", answer: "No, we can't.", options: ["Yes, we can.", "No, we can't."] },
  { condition: "It's cold and rainy.", question: "What can we do at home?", answer: "Make a card.", options: ["Play football.", "Make a card."] },
  { condition: "It's sunny and warm.", question: "Can we go to the park?", answer: "Yes, we can.", options: ["Yes, we can.", "No, we can't."] },
  { condition: "It's snowy.", question: "Let's...", answer: "make a snowman", options: ["swim", "make a snowman"] },
];

const DIALOGUE_DATA = [
  { speaker: "Mark", text: "Hello! Mark _______.", answer: "speaking", options: ["speaking", "talking", "saying"] },
  { speaker: "John", text: "Hi, Mark! _______ is John.", answer: "This", options: ["I", "This", "It"] },
  { speaker: "John", text: "What's the weather _______ in Sydney?", answer: "like", options: ["is", "like", "love"] },
];

// --- Components ---

const Button = ({ onClick, children, className = "", disabled = false, variant = "primary" }) => {
  const baseStyles = "px-6 py-3 rounded-full font-bold shadow-lg transform transition active:scale-95 flex items-center justify-center gap-2";
  const variants = {
    primary: "bg-gradient-to-r from-blue-500 to-indigo-600 text-white hover:-translate-y-1 hover:shadow-xl",
    secondary: "bg-white text-gray-800 border-2 border-gray-200 hover:border-blue-400 hover:bg-blue-50",
    success: "bg-green-500 text-white hover:bg-green-600",
    danger: "bg-red-500 text-white hover:bg-red-600",
    ai: "bg-gradient-to-r from-purple-500 to-pink-500 text-white hover:scale-105"
  };
  
  return (
    <button
      onClick={onClick}
      disabled={disabled}
      className={`${baseStyles} ${variants[variant] || variants.primary} ${className} ${disabled ? 'opacity-50 cursor-not-allowed hover:transform-none' : ''}`}
    >
      {children}
    </button>
  );
};

const Card = ({ children, className = "" }) => (
  <div className={`bg-white rounded-2xl shadow-xl p-6 md:p-8 ${className}`}>
    {children}
  </div>
);

const ProgressBar = ({ current, total }) => (
  <div className="w-full bg-gray-200 rounded-full h-4 mb-6">
    <div
      className="bg-blue-500 h-4 rounded-full transition-all duration-500"
      style={{ width: `${(current / total) * 100}%` }}
    ></div>
  </div>
);

// --- Game Levels ---

const LevelPhonetics = ({ onComplete }) => {
  const [index, setIndex] = useState(0);
  const [score, setScore] = useState(0);
  const [feedback, setFeedback] = useState(null); // 'correct' | 'wrong'
  const [isPlaying, setIsPlaying] = useState(false);

  const handleChoice = (type) => {
    if (feedback) return;
    const isCorrect = PHONETICS_DATA[index].type === type;
    setFeedback(isCorrect ? 'correct' : 'wrong');
    if (isCorrect) setScore(s => s + 1);

    setTimeout(() => {
      setFeedback(null);
      if (index < PHONETICS_DATA.length - 1) {
        setIndex(index + 1);
      } else {
        onComplete(score + (isCorrect ? 1 : 0), PHONETICS_DATA.length);
      }
    }, 1000);
  };

  const handleSpeak = async () => {
    if (isPlaying) return;
    setIsPlaying(true);
    await generateSpeech(PHONETICS_DATA[index].word);
    setIsPlaying(false);
  };

  const item = PHONETICS_DATA[index];

  return (
    <div className="text-center max-w-md mx-auto">
      <h2 className="text-2xl font-bold text-purple-600 mb-4">Level 1: æ£®æ—ä½è¯­ (Phonetics)</h2>
      <p className="text-gray-600 mb-6">è¿™ä¸ªå•è¯é‡Œçš„ <span className="font-bold text-xl text-blue-600">th</span> å‘ä»€ä¹ˆéŸ³ï¼Ÿ</p>
      <ProgressBar current={index} total={PHONETICS_DATA.length} />
      
      <Card className="mb-8 transform transition-all hover:scale-105 border-4 border-indigo-100 flex flex-col items-center">
        <div className="text-5xl font-extrabold text-indigo-600 mb-4">{item.word}</div>
        
        {/* Gemini TTS Button */}
        <button 
          onClick={handleSpeak}
          disabled={isPlaying}
          className={`flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-bold transition-all shadow-sm ${isPlaying ? 'bg-gray-100 text-gray-400' : 'bg-indigo-50 text-indigo-600 hover:bg-indigo-100 hover:scale-105'}`}
        >
          {isPlaying ? (
            <span className="flex items-center gap-2"><Loader size={14} className="animate-spin"/> AI Speaking...</span>
          ) : (
            <>
              <Sparkles size={16} /> 
              Hear AI Pronunciation
            </>
          )}
        </button>
      </Card>

      <div className="grid grid-cols-2 gap-4">
        <Button 
          onClick={() => handleChoice('voiced')} 
          variant={feedback === 'wrong' && item.type === 'voiced' ? 'success' : 'secondary'}
          className={`bg-yellow-50 text-yellow-900 border-yellow-200 hover:bg-yellow-100`}
        >
          <div className="flex flex-col items-center">
             <Volume2 size={24} className="mb-1" /> 
             <span>éœ‡åŠ¨éŸ³ /Ã°/</span>
             <span className="text-xs opacity-75 font-normal">(åƒèœœèœ‚)</span>
          </div>
        </Button>
        <Button 
          onClick={() => handleChoice('unvoiced')} 
          variant={feedback === 'wrong' && item.type === 'unvoiced' ? 'success' : 'secondary'}
          className={`bg-blue-50 text-blue-900 border-blue-200 hover:bg-blue-100`}
        >
          <div className="flex flex-col items-center">
             <Wind size={24} className="mb-1" /> 
             <span>æ°”æµéŸ³ /Î¸/</span>
             <span className="text-xs opacity-75 font-normal">(åƒå¹æ°”)</span>
          </div>
        </Button>
      </div>

      {feedback && (
        <div className={`mt-6 text-xl font-bold animate-bounce ${feedback === 'correct' ? 'text-green-500' : 'text-red-500'}`}>
          {feedback === 'correct' ? 'Great Job! ğŸ‰' : 'Oops! Try again next time!'}
        </div>
      )}
    </div>
  );
};

const LevelVocab = ({ onComplete }) => {
  const [index, setIndex] = useState(0);
  const [score, setScore] = useState(0);
  const [feedback, setFeedback] = useState(null);

  const handleChoice = (option) => {
    if (feedback) return;
    const isCorrect = VOCAB_DATA[index].answer === option;
    setFeedback(isCorrect ? 'correct' : 'wrong');
    if (isCorrect) setScore(s => s + 1);

    setTimeout(() => {
      setFeedback(null);
      if (index < VOCAB_DATA.length - 1) {
        setIndex(index + 1);
      } else {
        onComplete(score + (isCorrect ? 1 : 0), VOCAB_DATA.length);
      }
    }, 1000);
  };

  const item = VOCAB_DATA[index];

  return (
    <div className="text-center max-w-md mx-auto">
      <h2 className="text-2xl font-bold text-orange-500 mb-4">Level 2: æ°”è±¡é›·è¾¾ (Vocabulary)</h2>
      <ProgressBar current={index} total={VOCAB_DATA.length} />
      
      <Card className="mb-6 flex flex-col items-center justify-center h-48 bg-gradient-to-b from-blue-50 to-blue-100">
        <div className="mb-4">{item.icon}</div>
        <p className="text-xl text-gray-700 font-semibold">{item.question}</p>
      </Card>

      <div className="grid grid-cols-2 gap-3">
        {item.options.map((opt) => (
          <Button 
            key={opt} 
            onClick={() => handleChoice(opt)}
            variant={feedback === 'correct' && opt === item.answer ? 'success' : feedback === 'wrong' && opt === item.answer ? 'success' : 'secondary'}
            className="capitalize"
          >
            {opt}
          </Button>
        ))}
      </div>
      {feedback && (
        <div className={`mt-4 text-lg font-bold ${feedback === 'correct' ? 'text-green-600' : 'text-red-500'}`}>
           {feedback === 'correct' ? 'Correct! âœ…' : `The answer was ${item.answer}`}
        </div>
      )}
    </div>
  );
};

const LevelLogic = ({ onComplete }) => {
  const [index, setIndex] = useState(0);
  const [score, setScore] = useState(0);
  const [selected, setSelected] = useState(null);

  const handleChoice = (option) => {
    if (selected) return;
    setSelected(option);
    const isCorrect = option === LOGIC_DATA[index].answer;
    if (isCorrect) setScore(s => s + 1);

    setTimeout(() => {
      setSelected(null);
      if (index < LOGIC_DATA.length - 1) {
        setIndex(index + 1);
      } else {
        onComplete(score + (isCorrect ? 1 : 0), LOGIC_DATA.length);
      }
    }, 1200);
  };

  const item = LOGIC_DATA[index];

  return (
    <div className="text-center max-w-md mx-auto">
      <h2 className="text-2xl font-bold text-green-600 mb-4">Level 3: ç”Ÿå­˜æŠ‰æ‹© (Logic)</h2>
      <ProgressBar current={index} total={LOGIC_DATA.length} />

      <Card className="mb-6 bg-yellow-50 border-l-8 border-yellow-400 text-left">
        <h3 className="text-gray-500 text-sm uppercase tracking-wider mb-1">Situation</h3>
        <p className="text-xl font-bold text-gray-800">{item.condition}</p>
      </Card>

      <p className="text-lg mb-4 font-semibold text-gray-700">Question: {item.question}</p>

      <div className="space-y-3">
        {item.options.map(opt => (
          <Button
            key={opt}
            onClick={() => handleChoice(opt)}
            variant={
              selected === opt 
                ? (opt === item.answer ? 'success' : 'danger')
                : (selected && opt === item.answer ? 'success' : 'secondary')
            }
            className="w-full justify-center"
          >
            {opt}
          </Button>
        ))}
      </div>
    </div>
  );
};

const LevelDialogue = ({ onComplete }) => {
  const [index, setIndex] = useState(0);
  const [score, setScore] = useState(0);
  
  const handleChoice = (option) => {
    const isCorrect = option === DIALOGUE_DATA[index].answer;
    if (isCorrect) setScore(s => s + 1);
    
    if (index < DIALOGUE_DATA.length - 1) {
      setIndex(index + 1);
    } else {
      onComplete(score + (isCorrect ? 1 : 0), DIALOGUE_DATA.length);
    }
  };

  const item = DIALOGUE_DATA[index];
  const parts = item.text.split('_______');

  return (
    <div className="text-center max-w-md mx-auto">
      <h2 className="text-2xl font-bold text-pink-600 mb-4">Level 4: ç‰¹å·¥è¿çº¿ (Dialogue)</h2>
      <ProgressBar current={index} total={DIALOGUE_DATA.length} />

      <Card className="mb-8 bg-gray-50 p-6 relative">
        <div className="absolute top-0 left-0 bg-blue-600 text-white text-xs px-2 py-1 rounded-tl-lg rounded-br-lg">
          On the phone
        </div>
        <div className="flex items-start gap-4 mt-2">
          <div className="w-12 h-12 rounded-full bg-blue-100 flex items-center justify-center text-2xl border-2 border-blue-200">
            {item.speaker === 'Mark' ? 'ğŸ§‘' : 'ğŸ‘¦'}
          </div>
          <div className="text-left">
            <div className="text-sm text-gray-500 font-bold mb-1">{item.speaker}</div>
            <div className="text-xl text-gray-800 leading-relaxed">
              {parts[0]}
              <span className="inline-block w-24 border-b-4 border-dashed border-blue-400 mx-1">?</span>
              {parts[1]}
            </div>
          </div>
        </div>
      </Card>

      <div className="grid grid-cols-3 gap-2">
        {item.options.map(opt => (
          <Button 
            key={opt}
            onClick={() => handleChoice(opt)}
            variant="secondary"
            className="bg-indigo-50 text-indigo-700 hover:bg-indigo-100 text-sm"
          >
            {opt}
          </Button>
        ))}
      </div>
    </div>
  );
};

// --- Main App Component ---

export default function WeatherGame() {
  const [gameState, setGameState] = useState('menu'); // menu, playing, victory
  const [currentLevel, setCurrentLevel] = useState(1);
  const [totalScore, setTotalScore] = useState(0);
  const [maxScore, setMaxScore] = useState(0);
  const [levelScores, setLevelScores] = useState({});
  const [aiReport, setAiReport] = useState(null);
  const [isGenerating, setIsGenerating] = useState(false);

  const startGame = () => {
    setGameState('playing');
    setCurrentLevel(1);
    setTotalScore(0);
    setMaxScore(0);
    setLevelScores({});
    setAiReport(null);
  };

  const handleLevelComplete = (score, max) => {
    setTotalScore(s => s + score);
    setMaxScore(m => m + max);
    setLevelScores(prev => ({...prev, [currentLevel]: score}));

    if (currentLevel < 4) {
      setCurrentLevel(c => c + 1);
    } else {
      setGameState('victory');
    }
  };

  const handleGenerateReport = async () => {
    setIsGenerating(true);
    const prompt = `Write a short, funny, motivating 'Secret Agent Mission Report' (2-3 sentences max) for a Grade 4 student named Agent. They just completed a mission learning English weather words like 'sunny', 'windy', and 'Sydney'. The score was ${totalScore}/${maxScore}. Use simple English.`;
    const report = await generateAIContent(prompt);
    setAiReport(report);
    setIsGenerating(false);
  };

  const getStars = (percent) => {
    if (percent === 100) return 3;
    if (percent >= 60) return 2;
    if (percent > 0) return 1;
    return 0;
  };

  return (
    <div className="min-h-screen bg-slate-100 font-sans text-gray-800 py-8 px-4 flex flex-col items-center">
      
      {/* Header */}
      <header className="mb-8 text-center">
        <h1 className="text-3xl md:text-4xl font-black text-blue-600 tracking-tight flex items-center justify-center gap-2">
          <CloudRain className="text-blue-400" />
          æ°”è±¡ç‰¹å·¥: æ‚‰å°¼è¡ŒåŠ¨
          <Sun className="text-yellow-400" />
        </h1>
        <p className="text-gray-500 mt-2 font-medium">Unit 5: The Weather and Us</p>
      </header>

      {/* Game Area */}
      <div className="w-full max-w-2xl bg-white rounded-3xl shadow-2xl overflow-hidden min-h-[500px] flex flex-col relative">
        
        {/* Background Patterns */}
        <div className="absolute top-0 right-0 p-10 opacity-5 pointer-events-none">
          <Wind size={200} />
        </div>
        <div className="absolute bottom-0 left-0 p-10 opacity-5 pointer-events-none">
          <Snowflake size={200} />
        </div>

        <div className="p-6 md:p-10 flex-grow flex flex-col justify-center relative z-10">
          
          {gameState === 'menu' && (
            <div className="text-center space-y-8">
              <div className="inline-block p-6 bg-blue-50 rounded-full animate-pulse">
                <Play size={64} className="text-blue-600 ml-2" />
              </div>
              <div>
                <h2 className="text-2xl font-bold mb-2">å‡†å¤‡å¥½æ‰§è¡Œä»»åŠ¡äº†å—ï¼Ÿ</h2>
                <p className="text-gray-600">ä½ çš„ç›®æ ‡ï¼šæŒæ¡æ‰€æœ‰å¤©æ°”æƒ…æŠ¥ï¼</p>
              </div>
              <Button onClick={startGame} className="w-full text-xl py-4">
                å¼€å§‹è¡ŒåŠ¨ (Start Mission)
              </Button>
            </div>
          )}

          {gameState === 'playing' && (
            <>
              {currentLevel === 1 && <LevelPhonetics onComplete={handleLevelComplete} />}
              {currentLevel === 2 && <LevelVocab onComplete={handleLevelComplete} />}
              {currentLevel === 3 && <LevelLogic onComplete={handleLevelComplete} />}
              {currentLevel === 4 && <LevelDialogue onComplete={handleLevelComplete} />}
            </>
          )}

          {gameState === 'victory' && (
            <div className="text-center animate-fade-in-up">
              <div className="flex justify-center mb-6">
                <Award size={80} className="text-yellow-400 drop-shadow-lg" />
              </div>
              <h2 className="text-4xl font-extrabold text-gray-800 mb-2">ä»»åŠ¡å®Œæˆ!</h2>
              <p className="text-xl text-gray-600 mb-8">Mission Accomplished</p>
              
              <div className="bg-gray-50 rounded-xl p-6 mb-8 max-w-xs mx-auto">
                <div className="text-gray-500 uppercase text-xs font-bold tracking-wider mb-2">Final Score</div>
                <div className="text-5xl font-black text-blue-600 mb-2">{totalScore} <span className="text-2xl text-gray-400">/ {maxScore}</span></div>
                <div className="flex justify-center gap-1">
                  {[...Array(3)].map((_, i) => (
                     <Star key={i} size={24} className={i < getStars((totalScore/maxScore)*100) ? "text-yellow-400 fill-current" : "text-gray-300"} />
                  ))}
                </div>
              </div>

              {/* AI Mission Report Section */}
              {!aiReport ? (
                <div className="mb-8">
                  <Button 
                    variant="ai" 
                    onClick={handleGenerateReport} 
                    disabled={isGenerating}
                    className="w-full justify-center"
                  >
                    {isGenerating ? <Loader className="animate-spin" /> : <Sparkles />}
                    {isGenerating ? "Connecting to HQ..." : "Generate Secret Agent Report"}
                  </Button>
                </div>
              ) : (
                <Card className="mb-8 bg-gradient-to-br from-purple-50 to-pink-50 border-2 border-purple-100 transform rotate-1">
                   <h3 className="font-bold text-purple-600 text-sm uppercase tracking-widest mb-2">TOP SECRET: HQ REPORT</h3>
                   <p className="text-gray-700 italic font-medium leading-relaxed">"{aiReport}"</p>
                </Card>
              )}

              <Button onClick={startGame} variant="success" className="w-full">
                å†ç©ä¸€æ¬¡ (Play Again)
              </Button>
            </div>
          )}
        </div>
      </div>
      
      <footer className="mt-8 text-gray-400 text-sm">
        Review Aid for Grade 4 English â€¢ Unit 5 â€¢ Powered by Gemini AI
      </footer>
    </div>
  );
}
